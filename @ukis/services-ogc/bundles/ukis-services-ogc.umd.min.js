!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@ukis/services-layers"),require("@angular/common/http"),require("@boundlessgeo/jsonix"),require("rxjs/operators"),require("w3c-schemas/lib/XLink_1_0"),require("ogc-schemas/lib/OWS_1_1_0"),require("ogc-schemas/lib/SMIL_2_0"),require("ogc-schemas/lib/SMIL_2_0_Language"),require("ogc-schemas/lib/GML_3_1_1"),require("ogc-schemas/lib/WMTS_1_0"),require("rxjs"),require("ogc-schemas/lib/OWS_2_0"),require("ogc-schemas/lib/WPS_1_0_0"),require("ogc-schemas/lib/WPS_2_0")):"function"==typeof define&&define.amd?define("@ukis/services-ogc",["exports","@angular/core","@ukis/services-layers","@angular/common/http","@boundlessgeo/jsonix","rxjs/operators","w3c-schemas/lib/XLink_1_0","ogc-schemas/lib/OWS_1_1_0","ogc-schemas/lib/SMIL_2_0","ogc-schemas/lib/SMIL_2_0_Language","ogc-schemas/lib/GML_3_1_1","ogc-schemas/lib/WMTS_1_0","rxjs","ogc-schemas/lib/OWS_2_0","ogc-schemas/lib/WPS_1_0_0","ogc-schemas/lib/WPS_2_0"],t):t(((e=e||self).ukis=e.ukis||{},e.ukis["services-ogc"]={}),e.ng.core,e.servicesLayers,e.ng.common.http,e.jsonix,e.rxjs.operators,e.XLink_1_0$2,e.OWS_1_1_0$2,e.SMIL_2_0$1,e.SMIL_2_0_Language$1,e.GML_3_1_1$1,e.WMTS_1_0$1,e.rxjs,e.OWS_2_0$1,e.WPS_1_0_0$1,e.WPS_2_0$1)}(this,(function(e,t,r,n,o,s,i,a,p,u,c,l,f,h,m,y){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var d=function(){return(d=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function g(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}function w(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,s=r.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)i.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(o)throw o.error}}return i}var v=i.XLink_1_0,x=a.OWS_1_1_0,S=p.SMIL_2_0,b=u.SMIL_2_0_Language,O=c.GML_3_1_1,L=l.WMTS_1_0,R=function(){function e(e){this.http=e;var t=new o.Jsonix.Context([S,b,O,v,x,L]);this.xmlunmarshaller=t.createUnmarshaller(),this.xmlmarshaller=t.createMarshaller()}return e.prototype.getCapabilities=function(e,t){var r=this;void 0===t&&(t="1.1.0");var o=e+"?SERVICE=WMTS&REQUEST=GetCapabilities&VERSION="+t,i=new n.HttpHeaders({"Content-Type":"text/xml",Accept:"text/xml, application/xml"});return this.http.get(o,{headers:i,responseType:"text"}).pipe(s.map((function(e){return r.xmlunmarshaller.unmarshalString(e)})))},e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:n.HttpClient}]},e.ngInjectableDef=t.ɵɵdefineInjectable({factory:function(){return new e(t.ɵɵinject(n.HttpClient))},token:e,providedIn:"root"}),e}();function E(e){return"http://www.opengis.net/spec/owc-geojson/1.0/req/wms"===e||"http://schemas.opengis.net/wms/1.1.1"===e||"http://schemas.opengis.net/wms/1.1.0"===e}function T(e){return"http://www.opengis.net/spec/owc-geojson/1.0/req/wfs"===e}function _(e){return"http://www.opengis.net/spec/owc-geojson/1.0/req/wmts"===e||"http://schemas.opengis.net/wmts/1.0.0"===e||"http://schemas.opengis.net/wmts/1.1.0"===e}function I(e){return"http://www.opengis.net/spec/owc-geojson/1.0/req/xyz"===e}function W(e){return"http://www.opengis.net/spec/owc-geojson/1.0/req/geojson"===e}function C(e){if(e){var t=[];for(var r in e.split(",")){var n=e.split(",")[r].split("-");if(1==n.length)t.push(e.split(",")[r]);else if(2==n.length){var o=n[0].charCodeAt(0),s=n[1].charCodeAt(0);if(o<=s)for(var i=o;i<=s;i++)t.push(String.fromCharCode(i).toLowerCase());else for(i=o;i>=s;i--)t.push(String.fromCharCode(i).toLowerCase())}}return t}}var j=function(){function e(e){this.wmtsClient=e}return e.prototype.checkContext=function(e){var t;return(t=Array.isArray(e.properties.links)?e.properties.links.find((function(e){return"http://www.opengis.net/spec/owc-geojson/1.0/req/core"===e.href})):e.properties.links.profiles.find((function(e){return"http://www.opengis.net/spec/owc-geojson/1.0/req/core"===e})))||console.error("this is not a valid OWS Context v1.0!"),t},e.prototype.getContextTitle=function(e){return e.properties.title},e.prototype.getContextPublisher=function(e){return e.properties.publisher?e.properties.publisher:null},e.prototype.getContextExtent=function(e){return e.bbox?e.bbox:null},e.prototype.getResources=function(e){return e.features},e.prototype.getResourceTitle=function(e){return e.properties.title},e.prototype.getResourceUpdated=function(e){return e.properties.updated},e.prototype.getResourceDate=function(e){return e.properties.date?e.properties.date:null},e.prototype.getResourceOfferings=function(e){return e.properties.offerings?e.properties.offerings:null},e.prototype.isActive=function(e){var t=!0;return e.properties.hasOwnProperty("active")&&(t=e.properties.active),t},e.prototype.getResourceOpacity=function(e){var t=1;return e.properties.hasOwnProperty("opacity")&&(t=e.properties.opacity),t},e.prototype.getResourceAttribution=function(e){var t="";return e.properties.hasOwnProperty("attribution")&&(t=e.properties.attribution),t},e.prototype.getResourceShards=function(e){if(e.properties.hasOwnProperty("shards"))return e.properties.shards},e.prototype.convertOwcTimeToIsoTimeAndPeriodicity=function(e){var t=e.split("/"),r=3==t.length?t[0]+"/"+t[1]:e,n=3==t.length?t[2]:null;return n?{interval:r,periodicity:n}:r},e.prototype.getResourceDimensions=function(e){var t,r,n=this;if(e.properties.hasOwnProperty("dimensions")){var o={},s={};if(Array.isArray(e.properties.dimensions))try{for(var i=g(e.properties.dimensions),a=i.next();!a.done;a=i.next()){var p=a.value;s[p.name]=p}}catch(e){t={error:e}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}else s=e.properties.dimensions;for(var u in s){var c={};if(console.log(u),"time"===u||"ISO8601"==s[u].units){var l=s[u].value,f=l?l.split(",").map((function(e){return n.convertOwcTimeToIsoTimeAndPeriodicity(e)})):null;c={values:!f||f.length>1?f:f[0],units:s[u].units,display:{format:"YYYMMDD",period:s[u].display,default:"end"}}}else c=s[u];o[u]=c}return o}},e.prototype.getLayertypeFromOfferingCode=function(e){return E(e.code)?r.WmsLayertype:_(e.code)?r.WmtsLayertype:T(e.code)?r.WfsLayertype:W(e.code)?r.GeojsonLayertype:I(e.code)?r.XyzLayertype:e.code},e.prototype.checkIfServiceOffering=function(e){return!(e.contents||!e.operations)},e.prototype.checkIfDataOffering=function(e){return!(!e.contents||e.operations)},e.prototype.getOfferingContents=function(e){return this.checkIfServiceOffering(e)?e.operations:this.checkIfDataOffering(e)?e.contents:void 0},e.prototype.getLegendUrl=function(e){var t="";if(e.hasOwnProperty("styles")){var r=e.styles.filter((function(e){return e.default}));if(r.length>0)return r[0].legendURL}else e.hasOwnProperty("legendUrl")&&(t=e.legendUrl);return t},e.prototype.getIconUrl=function(e){var t="";return e.hasOwnProperty("iconUrl")&&(t=e.iconUrl),t},e.prototype.getLayers=function(e,t){var r,n,o=e.features,s=[];try{for(var i=g(o),a=i.next();!a.done;a=i.next()){var p=a.value,u=p.properties.offerings;if(u.length>0){var c=u.find((function(e){return E(e.code)}))||u.find((function(e){return _(e.code)}))||u.find((function(e){return T(e.code)}))||u[0];s.push(this.createLayerFromOffering(c,p,e,t))}}}catch(e){r={error:e}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return f.forkJoin(s)},e.prototype.createLayerFromOffering=function(e,t,n,o){var s=this.getLayertypeFromOfferingCode(e);return r.isRasterLayertype(s)?this.createRasterLayerFromOffering(e,t,n,o):r.isVectorLayertype(s)?this.createVectorLayerFromOffering(e,t,n):void console.error("This type of service ("+s+") has not been implemented yet.")},e.prototype.createVectorLayerFromOffering=function(e,t,n){var o=this.getLayertypeFromOfferingCode(e);if(!r.isVectorLayertype(o))return console.error("This type of layer '"+o+"' / offering '"+e.code+"' cannot be converted into a Vectorlayer"),null;var s,i;this.getIconUrl(e);e.operations&&(s=this.getUrlFromUri(e.operations[0].href)),e.operations&&this.getJsonFromUri(e.operations[0].href),e.contents&&(i=e.contents[0].content);var a=this.getLegendUrl(e),p={id:t.id,name:this.getResourceTitle(t),displayName:this.getDisplayName(e,t),visible:this.isActive(t),type:o,removable:!0,attribution:this.getResourceAttribution(t),continuousWorld:!1,opacity:this.getResourceOpacity(t),url:s||null,legendImg:a||null,data:i},u=new r.VectorLayer(p);return t.bbox?u.bbox=t.bbox:n&&n.bbox&&(u.bbox=n.bbox),f.of(u)},e.prototype.createRasterLayerFromOffering=function(e,t,n,o){var s,i=this.getLayertypeFromOfferingCode(e);if(!r.isRasterLayertype(i))return console.error("This type of offering '"+e.code+"' cannot be converted into a rasterlayer."),null;switch(i){case r.WmsLayertype:s=this.createWmsLayerFromOffering(e,t,n);break;case r.WmtsLayertype:s=this.createWmtsLayerFromOffering(e,t,n,o);break;case r.XyzLayertype:case r.CustomLayertype:}return s},e.prototype.createWmtsLayerFromOffering=function(e,t,n,o){return this.getWmtsOptions(e,t,n,o).pipe(s.map((function(e){return new r.WmtsLayer(e)})))},e.prototype.createWmsLayerFromOffering=function(e,t,n){var o=this.getWmsOptions(e,t,n),s=new r.WmsLayer(o);return f.of(s)},e.prototype.getWmtsOptions=function(e,t,r,n){var o,i=this.getRasterLayerOptions(e,t,r),a=this.getLayerForWMTS(e,t);if(e.styles){var p=e.styles.find((function(e){return e.default}));p&&(o=p.name)}return this.getMatrixSetForWMTS(e,t,n).pipe(s.map((function(e){var t={matrixSet:e.matrixSet,matrixIds:e.matrixIds,resolutions:e.resolutions};return d({},i,{type:"wmts",params:{layer:a,matrixSetOptions:t,projection:n,style:o,format:"image/png"}})})))},e.prototype.getLayerForWMTS=function(e,t){var r=w(this.parseOperationUrl(e,"GetTile"),2),n=(r[0],r[1]);if(n.LAYER)return n.LAYER;console.error("There is no layer-parameter in the offering "+e.code+" for resource "+t.id+".\n      Cannot infer layer.",e)},e.prototype.parseOperationUrl=function(e,t){if(e.operations){var r=e.operations.find((function(e){return e.code===t}));if(r)return[this.getUrlFromUri(r.href),this.getJsonFromUri(r.href)];console.error("There is no "+t+"-operation in the offering "+e.code+".",e)}else console.error("The offering "+e.code+" has no operations.",e)},e.prototype.getMatrixSetForWMTS=function(e,t,r){if(e.matrixSets){var n=e.matrixSets.find((function(e){return e.srs===r}));return f.of(n)}var o=w(this.parseOperationUrl(e,"GetCapabilities"),2),i=o[0];o[1];return this.wmtsClient.getCapabilities(i).pipe(s.map((function(e){var t=e.value.contents.tileMatrixSet.find((function(e){return e.identifier.value===r}));return{srs:r,matrixSet:t.identifier.value,matrixIds:t.tileMatrix.map((function(e){return e.identifier.value})),resolutions:t.tileMatrix.map((function(e){return e.scaleDenominator})),origin:{x:t.tileMatrix[0].topLeftCorner[1],y:t.tileMatrix[0].topLeftCorner[0]},tilesize:t.tileMatrix[0].tileHeight}})))},e.prototype.getWmsOptions=function(e,t,n){var o=this.getRasterLayerOptions(e,t,n);if(o.type===r.WmsLayertype){var s=this.getJsonFromUri(e.operations[0].href),i=void 0;e.styles&&(i=e.styles.find((function(e){return e.default})).name);var a={LAYERS:s.LAYERS,FORMAT:s.FORMAT,TIME:s.TIME,VERSION:s.VERSION,TILED:s.TILED,TRANSPARENT:!0,STYLES:i};return d({},o,{type:"wms",params:a})}console.error("resource "+t.id+" cannot be converted into a WMS-Layer",e)},e.prototype.getRasterLayerOptions=function(e,t,n){var o=this.getLayerOptions(e,t,n);if(r.isRasterLayertype(o.type))return d({},o,{type:o.type,url:this.getUrlFromUri(e.operations[0].href),subdomains:C(this.getResourceShards(t))});console.error("The layer "+o.id+" is not a rasterlayer",o)},e.prototype.getLayerOptions=function(e,t,r){var n={id:t.id,type:this.getLayertypeFromOfferingCode(e),name:this.getResourceTitle(t),removable:!0,continuousWorld:!1,opacity:this.getResourceOpacity(t),displayName:this.getDisplayName(e,t),visible:this.isActive(t),attribution:this.getResourceAttribution(t),dimensions:this.getResourceDimensions(t),legendImg:this.getLegendUrl(e),styles:e.styles};return t.bbox?n.bbox=t.bbox:r&&r.bbox&&(n.bbox=r.bbox),n},e.prototype.getUrlFromUri=function(e){return e.substring(0,e.indexOf("?"))},e.prototype.getJsonFromUri=function(e){var t=e.substr(e.lastIndexOf("?")+1),r={};return t.split("&").forEach((function(e){var t=e.split("=");r[t[0].toUpperCase()]=decodeURIComponent(t[1])})),r},e.prototype.getDisplayName=function(e,t){var r="";return e.hasOwnProperty("title")&&(r=e.title?e.title:this.getResourceTitle(t)),r},e.prototype.generateOwsContextFrom=function(e,t,r,n){var o,s;n||(n={lang:"",links:[],title:"",updated:""});var i={id:e,type:"FeatureCollection",properties:n,features:[]};r&&(i.bbox=r);try{for(var a=g(t),p=a.next();!p.done;p=a.next()){var u=p.value,c=this.generateResourceFromLayer(u);i.features.push(c)}}catch(e){o={error:e}}finally{try{p&&!p.done&&(s=a.return)&&s.call(a)}finally{if(o)throw o.error}}return i},e.prototype.generateResourceFromLayer=function(e){return{id:e.id,properties:{title:e.name,updated:null,offerings:[this.generateOfferingFromLayer(e)],opacity:e.opacity,attribution:e.attribution},type:"Feature",geometry:null}},e.prototype.generateOfferingFromLayer=function(e,t,n){var o={code:this.getOfferingCodeFromLayer(e),title:e.name};return e.type==r.GeojsonLayertype?o.contents=this.getContentsFromLayer(e):o.operations=this.getOperationsFromLayer(e),t&&(o.legendUrl=t),n&&(o.iconUrl=n),o},e.prototype.getOfferingCodeFromLayer=function(e){switch(e.type){case r.WmsLayertype:return"http://www.opengis.net/spec/owc-geojson/1.0/req/wms";case r.WmtsLayertype:return"http://www.opengis.net/spec/owc-geojson/1.0/req/wmts";case r.GeojsonLayertype:return"http://www.opengis.net/spec/owc-geojson/1.0/req/geojson";case r.XyzLayertype:return"http://www.opengis.net/spec/owc-geojson/1.0/req/xyz";default:return console.error("This type of layer ("+e.type+") has not been implemented yet."),null}},e.prototype.getContentsFromLayer=function(e){var t=[];switch(e.type){case r.GeojsonLayertype:var n={type:"FeatureCollection",content:JSON.stringify(e.data)};t.push(n);break;default:console.error("Cannot get contents for this type of vectorlayer: ("+e.type+")")}return t},e.prototype.getOperationsFromLayer=function(e){if(e instanceof r.RasterLayer)switch(e.type){case r.WmsLayertype:return this.getWmsOperationsFromLayer(e);case r.WmtsLayertype:return this.getWmtsOperationsFromLayer(e);case r.XyzLayertype:return this.getXyzOperationsFromLayer(e);default:return console.error("Cannot get operations for this type of layer: ("+e.type+")"),[]}else if(e instanceof r.VectorLayer)return e.type,console.error("This type of service ("+e.type+") has not been implemented yet."),[]},e.prototype.getXyzOperationsFromLayer=function(e){return[{code:"REST",method:"GET",type:"text/html",href:""+e.url}]},e.prototype.getTmsOperationsFromLayer=function(e){return[]},e.prototype.getWfsOperationsFromLayer=function(e){var t=e.url;e.name;return[{code:"GetFeature",method:"GET",type:"application/json",href:t+"?service=WFS&version="+(e.options.version?e.options.version:"1.1.0")+"&request=GetFeature"}]},e.prototype.getWmsOperationsFromLayer=function(e){var t=e.url,r=e.params.VERSION,n=(e.name,e.id),o="image/vnd.jpeg-png";return e.params&&e.params.FORMAT&&(o=e.params.FORMAT),[{code:"GetMap",method:"GET",type:o,href:t+"?service=WMS&version="+r+"&request=GetMap&TRANSPARENT=TRUE&LAYERS="+n+"&FORMAT="+o+"&TILED=true"},{code:"GetCapabilities",method:"GET",type:"application/xml",href:t+"?service=WMS&version="+r+"&request=GetCapabilities"},{code:"GetFeatureInfo",method:"GET",type:"text/html",href:t+"?service=WMS&version="+r+"&request=GetFeatureInfo&TRANSPARENT=TRUE&LAYERS="+n+"&FORMAT="+o}]},e.prototype.getWmtsOperationsFromLayer=function(e){var t=e.url,r=e.params.version,n=(e.name,e.id),o="image/vnd.jpeg-png";return e.params&&e.params.FORMAT&&(o=e.params.FORMAT),[{code:"GetTile",href:t+"?SERVICE=WMTS&REQUEST=GetTile&FORMAT="+o+"&LAYER="+n+"&VERSION="+r,method:"GET",type:o},{code:"GetCapabilities",href:t+"?SERVICE=WMTS&REQUEST=GetCapabilities&VERSION="+r,method:"GET",type:"application/xml"},{code:"GetFeatureInfo",href:t+"?SERVICE=WMS&REQUEST=GetFeatureInfo&VERSION="+r,method:"GET",type:"text/html"}]},e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:R}]},e.ngInjectableDef=t.ɵɵdefineInjectable({factory:function(){return new e(t.ɵɵinject(R))},token:e,providedIn:"root"}),e}();var F=function(){function e(){}return e.prototype.getCapabilitiesUrl=function(e){return e+"?service=WPS&request=GetCapabilities&version=1.0.0"},e.prototype.executeUrl=function(e,t){return e+"?service=WPS&request=Execute&version=1.0.0&identifier="+t},e.prototype.unmarshalCapabilities=function(e){var t=[];return e.processOfferings.process.forEach((function(e){t.push({id:e.identifier.value})})),t},e.prototype.unmarshalSyncExecuteResponse=function(e,t,r,n,o){var s,i,a=[];if(e.value.status.processFailed)a.push({description:{id:e.value.process.identifier.value,reference:!0,type:"error"},value:e.value.statusLocation});else if(e.value.processOutputs)try{for(var p=g(e.value.processOutputs.output),u=p.next();!u.done;u=p.next()){var c=u.value,l=!!c.reference,f=void 0,h=void 0,m=void 0;c.reference?(f="complex",h=c.reference.href||null,m=c.reference.mimeType):(c.data&&c.data.literalData?(f="literal",m=c.data.literalData.dataType):c.data&&c.data.complexData?(f="complex",m=c.data.complexData.mimeType):(f="bbox",m=void 0),h=this.unmarshalOutputData(c.data)),a.push({description:{id:c.identifier.value,format:m,reference:l,type:f},value:h})}}catch(e){s={error:e}}finally{try{u&&!u.done&&(i=p.return)&&i.call(p)}finally{if(s)throw s.error}}else e.value.statusLocation&&a.push({description:{id:e.value.process.identifier.value,reference:!0,type:"status"},value:this.unmarshalGetStateResponse(e,t,r,n,o)});return a},e.prototype.unmarshalOutputData=function(e){if(e.complexData)switch(e.complexData.mimeType){case"application/vnd.geo+json":case"application/json":return e.complexData.content.map((function(e){return JSON.parse(e)}));case"application/WMS":return e.complexData.content;case"text/xml":return(new XMLSerializer).serializeToString(e.complexData.content[0]);default:throw new Error("Cannot unmarshal data of format "+e.complexData.mimeType)}else if(e.literalData)switch(e.literalData.dataType){case"string":default:return e.literalData.value}throw new Error("Not yet implemented: "+e)},e.prototype.unmarshalAsyncExecuteResponse=function(e,t,r,n,o){return this.unmarshalGetStateResponse(e,t,r,n,o)},e.prototype.unmarshalGetStateResponse=function(e,t,r,n,o){var s=e.value,i={status:s.status.processSucceeded?"Succeeded":s.status.processAccepted?"Accepted":s.status.processStarted?"Running":(s.status.processFailed,"Failed"),statusLocation:s.statusLocation};return s.processOutputs&&s.processOutputs.output&&(i.results=this.unmarshalSyncExecuteResponse(e,t,r,n,o)),i},e.prototype.marshalExecBody=function(e,t,r,n){return{name:{key:"{http://www.opengis.net/wps/1.0.0}Execute",localPart:"Execute",namespaceURI:"http://www.opengis.net/wps/1.0.0",prefix:"wps",string:"{http://www.opengis.net/wps/1.0.0}wps:Execute"},value:{dataInputs:this.marshalInputs(t),identifier:e,responseForm:this.marshalResponseForm(r,n),service:"WPS",version:"1.0.0"}}},e.prototype.marshalResponseForm=function(e,t){var r,n;void 0===t&&(t=!1);var o=[];try{for(var s=g(e),i=s.next();!i.done;i=s.next()){var a=i.value,p=void 0;switch(a.type){case"literal":case"complex":p={identifier:{value:a.id},asReference:a.reference,mimeType:a.format};break;default:throw new Error("This Wps-outputtype has not been implemented yet! "+a+" ")}o.push(p)}}catch(e){r={error:e}}finally{try{i&&!i.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return{responseDocument:{output:o,status:!!t,storeExecuteResponse:!!t}}},e.prototype.marshalInputs=function(e){var t,r,n=[];try{for(var o=g(e),s=o.next();!s.done;s=o.next()){var i=s.value;if(null===i.value||void 0===i.value)throw new Error("Value for input "+i.description.id+" is not set");var a=this.marshalInput(i);n.push(a)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}return{input:n}},e.prototype.marshalInput=function(e){var t={identifier:{value:e.description.id},title:{value:e.description.id},_abstract:{value:""}};return e.description.reference?t.reference=this.marshalReferenceInput(e):t.data=this.marshalDataInput(e),t},e.prototype.marshalDataInput=function(e){var t;switch(e.description.type){case"literal":t={literalData:{value:String(e.value)}};break;case"bbox":var r=e.value;t={boundingBoxData:{lowerCorner:[r.lllat,r.lllon],upperCorner:[r.urlat,r.urlon]}};break;case"complex":switch(e.description.format){case"text/xml":t={complexData:{content:[e.value],mimeType:e.description.format}};break;default:t={complexData:{content:[JSON.stringify(e.value)],mimeType:e.description.format}}}break;default:throw Error("This input is of type "+e.description.type+". We can only marshal input of type literal, bbox or complex.")}return t},e.prototype.marshalReferenceInput=function(e){return{href:e.value,method:"GET",mimeType:e.description.format}},e.prototype.marshallGetStatusBody=function(e,t,r){return{}},e.prototype.marshallGetResultBody=function(e,t,r){return{}},e.prototype.dismissUrl=function(e,t,r){throw new Error("Wps 1.0 does not support Dismiss-operations.")},e.prototype.marshalDismissBody=function(e){throw new Error("Wps 1.0 does not support Dismiss-operations.")},e.prototype.unmarshalDismissResponse=function(e,t,r){throw new Error("Wps 1.0 does not support Dismiss-operations.")},e}(),M=function(e){return e.hasOwnProperty("jobID")&&e.hasOwnProperty("status")},D=function(){function e(){}return e.prototype.getCapabilitiesUrl=function(e){return e+"?service=WPS&request=GetCapabilities&version=2.0.0"},e.prototype.executeUrl=function(e,t){return e+"?service=WPS&request=Execute&version=2.0.0&identifier="+t},e.prototype.unmarshalCapabilities=function(e){var t=[];return e.contents.processSummary.forEach((function(e){t.push({id:e.identifier.value})})),t},e.prototype.unmarshalSyncExecuteResponse=function(e,t,r,n,o){var s,i,a,p=[];if((a=e.value).hasOwnProperty("output")&&"object"==typeof a.output){var u=function(e){var t=o.find((function(t){return t.id===e.id}));if(!t)throw new Error("Could not find an output-description for the parameter "+e.id+".");var r=t.reference,n=t.type,s=t.format,i=void 0;if(e.reference)i=e.reference.href||null;else{if(!e.data)throw new Error("Output has neither reference nor data field.");i=c.unmarshalOutputData(e.data,t)}p.push({description:{id:e.id,format:s,reference:r,type:n},value:i})},c=this;try{for(var l=g(e.value.output),f=l.next();!f.done;f=l.next()){u(f.value)}}catch(e){s={error:e}}finally{try{f&&!f.done&&(i=l.return)&&i.call(l)}finally{if(s)throw s.error}}}else if(M(e.value)){var h={status:e.value.status,jobID:e.value.jobID,percentCompleted:e.value.percentCompleted};p.push({description:{id:r,reference:!0,type:"status"},value:h})}return p},e.prototype.unmarshalOutputData=function(e,t){if("complex"===t.type)switch(e.mimeType){case"application/vnd.geo+json":case"application/json":return e.content.map((function(e){return JSON.parse(e)}));case"application/WMS":return e.content;case"text/xml":return(new XMLSerializer).serializeToString(e.content[0]);default:throw new Error("Cannot unmarshal complex data of format "+e.mimeType)}else if("literal"===t.type)return e.content;throw new Error("Not yet implemented: "+e)},e.prototype.unmarshalAsyncExecuteResponse=function(e,t,r,n,o){return this.unmarshalGetStateResponse(e,t,r,n,o)},e.prototype.unmarshalGetStateResponse=function(e,t,r,n,o){if(M(e.value))return{status:e.value.status,jobID:e.value.jobID,percentCompleted:e.value.percentCompleted};throw new Error("Not a status-info: "+e)},e.prototype.marshalExecBody=function(e,t,r,n){return{name:{key:"{http://www.opengis.net/wps/2.0}Execute",localPart:"Execute",namespaceURI:"http://www.opengis.net/wps/2.0",prefix:"wps",string:"{http://www.opengis.net/wps/2.0}wps:Execute"},value:{TYPE_NAME:"WPS_2_0.ExecuteRequestType",service:"WPS",version:"2.0.0",identifier:{value:e},input:this.marshalInputs(t),output:this.marshalOutputs(r),mode:n?"async":"sync",response:"document"}}},e.prototype.marshalInputs=function(e){return e.map((function(e){return e.description.reference?{id:e.description.id,reference:{href:e.value,mimeType:e.description.format}}:{id:e.description.id,data:{content:[JSON.stringify(e.value)],mimeType:e.description.format}}}))},e.prototype.marshalOutputs=function(e){return e.map((function(e){return{id:e.id,mimeType:e.format,transmission:e.reference?"reference":"value"}}))},e.prototype.marshallGetStatusBody=function(e,t,r){return{name:{key:"{http://www.opengis.net/wps/2.0}GetStatus",localPart:"GetStatus",namespaceURI:"http://www.opengis.net/wps/2.0",prefix:"wps",string:"{http://www.opengis.net/wps/2.0}wps:GetStatus"},value:{jobID:r,service:"WPS",version:"2.0.0"}}},e.prototype.marshallGetResultBody=function(e,t,r){return{name:{key:"{http://www.opengis.net/wps/2.0}GetResult",localPart:"GetResult",namespaceURI:"http://www.opengis.net/wps/2.0",prefix:"wps",string:"{http://www.opengis.net/wps/2.0}wps:GetResult"},value:{service:"WPS",version:"2.0.0",jobID:r}}},e.prototype.dismissUrl=function(e,t,r){return e},e.prototype.marshalDismissBody=function(e){return{name:{key:"{http://www.opengis.net/wps/2.0}Dismiss",localPart:"Dismiss",namespaceURI:"http://www.opengis.net/wps/2.0",prefix:"wps",string:"{http://www.opengis.net/wps/2.0}wps:Dismiss"},value:{jobID:e,service:"WPS",version:"2.0.0"}}},e.prototype.unmarshalDismissResponse=function(e,t,r){return{status:e.value.status,jobID:e.value.jobID}},e}();function G(e,t){void 0===t&&(t=3);var r=1;return(function(n){return n.pipe(s.retryWhen((function(n){return n.pipe(s.delay(e),s.mergeMap((function(e){if(e.status&&400===e.status)throw e;if(r<=t)return console.log("http-error. Retrying ..."),r+=1,f.of(e);throw console.log("Persistent http-errors after "+r+" attempts. Giving up."),e})))})))})}var P=function(){function e(){}return e.prototype.set=function(e,t){},e.prototype.get=function(e){return f.of(null)},e}(),U=i.XLink_1_0,A=a.OWS_1_1_0,q=h.OWS_2_0,k=m.WPS_1_0_0,N=y.WPS_2_0,V=function(){function e(e,t,r){var n;if(void 0===e&&(e="1.0.0"),this.webclient=t,this.cache=new P,this.version=e,r&&(this.cache=r),"1.0.0"===this.version)this.wpsmarshaller=new F,n=new o.Jsonix.Context([U,A,k]);else{if("2.0.0"!==this.version)throw new Error("You entered a WPS version other than 1.0.0 or 2.0.0.");this.wpsmarshaller=new D,n=new o.Jsonix.Context([U,q,N])}this.xmlunmarshaller=n.createUnmarshaller(),this.xmlmarshaller=n.createMarshaller()}return e.prototype.getCapabilities=function(e){var t=this,r=this.wpsmarshaller.getCapabilitiesUrl(e);return this.getRaw(r).pipe(s.map((function(e){var r=t.xmlunmarshaller.unmarshalString(e);return t.wpsmarshaller.unmarshalCapabilities(r.value)})))},e.prototype.describeProcess=function(e){throw new Error("Not implemented yet")},e.prototype.executeAsync=function(e,t,r,n,o,i){var a=this;void 0===o&&(o=1e3);var p=this.executeAsyncS(e,t,r,n).pipe(s.mergeMap((function(p){return function(e,t,r,n){void 0===n&&(n=1e3),r&&r(null);var o=e.pipe(s.tap((function(e){r&&r(e)}))),i=f.forkJoin(o,f.timer(n)).pipe(s.map((function(e){return e[0]}))).pipe(s.mergeMap((function(e){return t(e)?f.of(e):i})));return i}(a.getNextState(p,e,t,r,n),(function(e){return"Succeeded"===e.status}),i,o)})),s.mergeMap((function(o){return a.fetchResults(o,e,t,r,n)})),s.tap((function(e){var t,r;try{for(var n=g(e),o=n.next();!o.done;o=n.next()){var s=o.value;if("error"===s.description.type)throw console.log("server responded with 200, but body contained an error-result: ",s),new Error(s.value)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(r=n.return)&&r.call(n)}finally{if(t)throw t.error}}})));return this.cachedQuery(e,t,r,n,p)},e.prototype.cachedQuery=function(e,t,r,n,o){var i=this;return this.cache.get({url:e,processId:t,inputs:r,outputs:n}).pipe(s.switchMap((function(a){return a?f.of(a):o.pipe(s.tap((function(o){i.cache.set({url:e,processId:t,inputs:r,outputs:n},o)})))})))},e.prototype.getNextState=function(e,t,r,n,o){var i,a=this;if("1.0.0"===this.version){if(!e.statusLocation)throw Error("No status location");i=this.getRaw(e.statusLocation)}else{if("2.0.0"!==this.version)throw new Error("'GetStatus' has not yet been implemented for this WPS-Version ("+this.version+").");if(!e.jobID)throw Error("No job-Id");var p=this.wpsmarshaller.marshallGetStatusBody(t,r,e.jobID),u=this.xmlmarshaller.marshalString(p);i=this.postRaw(t,u)}return i.pipe(G(2e3,2),s.map((function(e){var s=a.xmlunmarshaller.unmarshalString(e);return a.wpsmarshaller.unmarshalGetStateResponse(s,t,r,n,o)})))},e.prototype.fetchResults=function(e,t,r,n,o){var i=this;if(e.results)return f.of(e.results);if(!e.jobID)throw new Error("You want me to get a result, but I can't find a jobId. I don't know what to do now!");var a=this.wpsmarshaller.marshallGetResultBody(t,r,e.jobID),p=this.xmlmarshaller.marshalString(a);return this.postRaw(t,p).pipe(s.map((function(e){var s=i.xmlunmarshaller.unmarshalString(e);return i.wpsmarshaller.unmarshalSyncExecuteResponse(s,t,r,n,o)})))},e.prototype.executeAsyncS=function(e,t,r,n){var o=this,i=this.wpsmarshaller.executeUrl(e,t),a=this.wpsmarshaller.marshalExecBody(t,r,n,!0),p=this.xmlmarshaller.marshalString(a);return this.postRaw(i,p).pipe(s.map((function(s){var i=o.xmlunmarshaller.unmarshalString(s);return o.wpsmarshaller.unmarshalAsyncExecuteResponse(i,e,t,r,n)})))},e.prototype.execute=function(e,t,r,n){var o=this,i=this.wpsmarshaller.executeUrl(e,t),a=this.wpsmarshaller.marshalExecBody(t,r,n,!1),p=this.xmlmarshaller.marshalString(a);return this.postRaw(i,p).pipe(s.map((function(s){var i=o.xmlunmarshaller.unmarshalString(s);return o.wpsmarshaller.unmarshalSyncExecuteResponse(i,e,t,r,n)})))},e.prototype.dismiss=function(e,t,r){var n=this,o=this.wpsmarshaller.dismissUrl(e,t,r),i=this.wpsmarshaller.marshalDismissBody(r),a=this.xmlmarshaller.marshalString(i);return this.postRaw(o,a).pipe(s.map((function(r){var o=n.xmlunmarshaller.unmarshalString(r);return n.wpsmarshaller.unmarshalDismissResponse(o,e,t)})))},e.prototype.postRaw=function(e,t){return this.webclient.post(e,t,{headers:{"Content-Type":"text/xml",Accept:"text/xml, application/xml"},responseType:"text"}).pipe(G(2e3,2),s.share())},e.prototype.getRaw=function(e){return this.webclient.get(e,{headers:{Accept:"text/xml, application/xml"},responseType:"text"}).pipe(G(2e3,2))},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:void 0,decorators:[{type:t.Inject,args:["WpsVersion"]}]},{type:n.HttpClient},{type:void 0,decorators:[{type:t.Inject,args:["WpsCache"]}]}]},e}();var J=function(){function e(){}return e.decorators=[{type:t.NgModule,args:[{declarations:[],imports:[],exports:[],providers:[j,R,V]}]}],e}();e.FakeCache=P,e.OwcJsonService=j,e.ServicesOgcModule=J,e.WmtsClientService=R,e.WpsClient=V,e.isBbox=function(e){return e.hasOwnProperty("crs")&&e.hasOwnProperty("lllon")&&e.hasOwnProperty("lllat")&&e.hasOwnProperty("urlon")&&e.hasOwnProperty("urlat")},e.isCswOffering=function(e){return"http://www.opengis.net/spec/owc-geojson/1.0/req/csw"===e},e.isGMLCOVOffering=function(e){return"http://www.opengis.net/spec/owc-geojson/1.0/req/gmlcov"===e},e.isGMLJP2Offering=function(e){return"http://www.opengis.net/spec/owc-geojson/1.0/req/gmljp2"===e},e.isGeoJsonOffering=W,e.isGeoTIFFOffering=function(e){return"http://www.opengis.net/spec/owc-geojson/1.0/req/geotiff"===e},e.isGmlOffering=function(e){return"http://www.opengis.net/spec/owc-geojson/1.0/req/gml"===e},e.isKmlOffering=function(e){return"http://www.opengis.net/spec/owc-geojson/1.0/req/kml"===e},e.isWfsOffering=T,e.isWmsOffering=E,e.isWmtsOffering=_,e.isWpsOffering=function(e){return"http://www.opengis.net/spec/owc-geojson/1.0/req/wcs"===e},e.isWpsState=function(e){return e&&e.hasOwnProperty("status")&&(e.hasOwnProperty("jobID")||e.hasOwnProperty("statusLocation"))},e.isXyzOffering=I,e.shardsExpand=C,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=ukis-services-ogc.umd.min.js.map